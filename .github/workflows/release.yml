name: Release Android APK

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.19.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: Install Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Install Android Build Tools
      run: |
        sdkmanager --install "build-tools;34.0.0" "platforms;android-34" "platform-tools"
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flet
        pip install -r requirements.txt
        
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Build Android APK
      run: |
        echo "Building release APK version ${{ steps.get_version.outputs.VERSION }}"
        flet build apk \
          --verbose \
          --project "YT-Music-Downloader" \
          --product "YT Music Downloader" \
          --company "ExApps" \
          --copyright "Copyright (c) 2024 ExApps" \
          --build-version "${{ steps.get_version.outputs.VERSION }}" \
          --build-number ${{ github.run_number }} \
          --module "main"
      env:
        ANDROID_SDK_ROOT: ${{ env.ANDROID_HOME }}
        
    - name: Prepare release assets
      run: |
        mkdir -p release
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        BUILD_NUM=${{ github.run_number }}
        
        # Find and rename the APK
        if [ -f "build/apk/app-release.apk" ]; then
          cp "build/apk/app-release.apk" "release/YT-Music-Downloader-v${VERSION}.apk"
          echo "Found release APK"
        elif [ -f "build/apk/app.apk" ]; then
          cp "build/apk/app.apk" "release/YT-Music-Downloader-v${VERSION}.apk"
          echo "Found app APK"
        else
          # Find any APK
          APK_FILE=$(find build -name "*.apk" -type f | head -1)
          if [ -n "$APK_FILE" ]; then
            cp "$APK_FILE" "release/YT-Music-Downloader-v${VERSION}.apk"
            echo "Found APK: $APK_FILE"
          fi
        fi
        
        # Create checksums
        cd release
        sha256sum *.apk > checksums.txt
        cd ..
        
        ls -la release/
        
    - name: Upload APK to GitHub Releases
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          release/*.apk
          release/checksums.txt
        name: "YT Music Downloader v${{ steps.get_version.outputs.VERSION }}"
        body: |
          ## YT Music Downloader v${{ steps.get_version.outputs.VERSION }}
          
          ### What's New
          - Download music from YouTube
          - Multiple audio formats (MP3, FLAC, Opus, AAC)
          - Playlist support
          - Parallel downloads
          - Dark theme
          
          ### Installation
          Download the APK file and install it on your Android device.
          
          ### Package Info
          - **Package Name:** com.exapps.ytdownload
          - **Minimum Android Version:** 5.0 (API 21)
          - **Target Android Version:** 14 (API 34)
          
          ### Permissions
          - Internet access
          - Storage access (for saving downloads)
          - Notifications (for download progress)
          
          ### Checksums
          See `checksums.txt` for SHA256 checksums.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: YT-Music-Downloader-v${{ steps.get_version.outputs.VERSION }}
        path: release/*.apk
        if-no-files-found: error
